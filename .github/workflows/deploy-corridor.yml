name: deploy to pj-corridor.net

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'pj-corridor.net/**'
      - 'stick-figure/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      INDEXOBJ: pj-corridor.net/index.html
      ADTXTOBJ: pj-corridor.net/ads.txt
      IMAGEDIR: pj-corridor.net/images/
      APPL1DIR: pj-corridor.net/cube3d/
      APPL2DIR: stick-figure/
      APPL3DIR: pj-corridor.net/personalitytest/
      GA256DIR: pj-corridor.net/gallery-256/
      GAFULDIR: pj-corridor.net/gallery-fullcolor/
      APPL4DIR: pj-corridor.net/side-six/
      S3BUCKET: pj-corridor.net
      VERSION: version.txt
    steps:
    - name: checkout
      uses: actions/checkout@v4
    - name: configure credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-1
    - name: prepare version file
      run: |
        echo "${{ github.sha }}" > "${{ env.VERSION }}"
    - name: check IAM policy
      run: |
        set -e
        for POLICY in CIPolicyCorridorBoundary.json AppPolicyPersonalitytest.json; do
          echo "Checking policy: ${POLICY}"
          ARN="arn:aws:iam::256385929234:policy/${POLICY}"
          VID=$(aws iam get-policy \
            --policy-arn "${ARN}" \
            --query 'Policy.DefaultVersionId' \
            --output text)
          aws iam get-policy-version \
            --policy-arn "${ARN}" \
            --version-id "${VID}" \
            --query 'PolicyVersion.Document' \
            --output json > "current-${POLICY}"
          jq -S . ".github/workflows/${POLICY}" > "${POLICY}.sorted"
          jq -S . "current-${POLICY}" > "current-${POLICY}.sorted"
          diff "${POLICY}.sorted" "current-${POLICY}.sorted"
        done
    - name: pre-check modified
      run: |
        git fetch --depth=2
        echo "CURR_SHA=${{ github.sha }}" >> $GITHUB_ENV
        echo "PREV_SHA=$(git rev-parse ${{ github.sha }}^)" >> $GITHUB_ENV
        echo "CURR_SHA=${{ github.sha }}"
        echo "PREV_SHA=$(git rev-parse ${{ github.sha }}^)"
    - name: check modified
      run: |
        FILES=$(git diff --name-only $PREV_SHA $CURR_SHA | tr '\n' ' ')
        echo "FILES=$FILES" >> $GITHUB_ENV
    - name: copy
      if: contains(env.FILES, env.INDEXOBJ)
      run: |
        SRC="${{ env.INDEXOBJ }}"
        DST="s3://${{ env.S3BUCKET }}/"
        aws s3 cp "${SRC}" "${DST}"
        aws s3 cp "${{ env.VERSION }}" "${DST}"
    - name: copy
      if: contains(env.FILES, env.ADTXTOBJ)
      run: |
        SRC="${{ env.ADTXTOBJ }}"
        DST="s3://${{ env.S3BUCKET }}/"
        aws s3 cp "${SRC}" "${DST}"
        aws s3 cp "${{ env.VERSION }}" "${DST}"
    - name: sync-images
      if: contains(env.FILES, env.IMAGEDIR)
      run: |
        SRC="${{ env.IMAGEDIR }}"
        DST="s3://${{ env.S3BUCKET }}/images/"
        aws s3 sync "${SRC}" "${DST}" --exclude ".git/*"
        aws s3 cp "${{ env.VERSION }}" "${DST}"
    - name: sync-cube3d
      if: contains(env.FILES, env.APPL1DIR)
      run: |
        SRC="${{ env.APPL1DIR }}"
        DST="s3://${{ env.S3BUCKET }}/cube3d/"
        aws s3 sync "${SRC}" "${DST}" --exclude ".git/*"
        aws s3 cp "${{ env.VERSION }}" "${DST}"
    - name: sync-stick-figure
      if: contains(env.FILES, env.APPL2DIR)
      run: |
        SRC="${{ env.APPL2DIR }}"
        DST="s3://${{ env.S3BUCKET }}/stick-figure/"
        aws s3 sync "${SRC}" "${DST}" --exclude ".git/*"
        aws s3 cp "${{ env.VERSION }}" "${DST}"
    - name: sync-personalitytest
      if: contains(env.FILES, env.APPL3DIR)
      run: |
        SRC="${{ env.APPL3DIR }}"
        DST="s3://${{ env.S3BUCKET }}/personalitytest/"
        aws s3 sync "${SRC}" "${DST}" --exclude ".git/*" --exclude "lambda/**"
        aws s3 cp "${{ env.VERSION }}" "${DST}"
    - name: sync-gallery-256
      if: contains(env.FILES, env.GA256DIR)
      run: |
        SRC="${{ env.GA256DIR }}"
        DST="s3://${{ env.S3BUCKET }}/gallery-256/"
        aws s3 sync "${SRC}" "${DST}" --exclude ".git/*"
        aws s3 cp "${{ env.VERSION }}" "${DST}"
    - name: sync-gallery-fullcolor
      if: contains(env.FILES, env.GAFULDIR)
      run: |
        SRC="${{ env.GAFULDIR }}"
        DST="s3://${{ env.S3BUCKET }}/gallery-fullcolor/"
        aws s3 sync "${SRC}" "${DST}" --exclude ".git/*"
        aws s3 cp "${{ env.VERSION }}" "${DST}"
    - name: sync-side-six
      if: contains(env.FILES, env.APPL4DIR)
      run: |
        SRC="${{ env.APPL4DIR }}"
        DST="s3://${{ env.S3BUCKET }}/side-six/"
        aws s3 sync "${SRC}" "${DST}" --exclude ".git/*"
        aws s3 cp "${{ env.VERSION }}" "${DST}"
    - name: clear cache
      run: |
        aws cloudfront create-invalidation --distribution-id ${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION }} --paths "/*"

