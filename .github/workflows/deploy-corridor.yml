name: deploy to pj-corridor.net

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'pj-corridor.net/**'

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      MODIFIEDLIST: ""
      ROOTDIR: pj-corridor.net
      INDEXFILE: index.html
      ADTXTFILE: ads.txt
      IMAGEDIR: images
      APPL1DIR: cube3d
      APPL2DIR: stick-figure
      APPL3DIR: personalitytest
      GA256DIR: gallery-256
      GAFULDIR: gallery-fullcolor
      APPL4DIR: side-six
      S3BUCKET: pj-corridor.net
      VERSION: version.txt
    steps:
    - name: checkout
      uses: actions/checkout@v4
    - name: configure credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-1
    - name: prepare version file
      run: |
        echo "${{ github.sha }}" > "${{ env.VERSION }}"
    - name: check IAM policy
      run: |
        set -euo pipefail
        for POLICY in CIPolicyCorridorBoundary.json AppPolicyPersonalitytest.json; do
          echo "Checking policy: ${POLICY}"
          ARN="arn:aws:iam::256385929234:policy/${POLICY}"
          VID=$(aws iam get-policy \
            --policy-arn "${ARN}" \
            --query 'Policy.DefaultVersionId' \
            --output text)
          aws iam get-policy-version \
            --policy-arn "${ARN}" \
            --version-id "${VID}" \
            --query 'PolicyVersion.Document' \
            --output json > "current-${POLICY}"
          jq -S . ".github/workflows/${POLICY}" > "${POLICY}.sorted"
          jq -S . "current-${POLICY}" > "current-${POLICY}.sorted"
          diff "${POLICY}.sorted" "current-${POLICY}.sorted"
        done
    - name: check WAF policy
      run: |
        set -euo pipefail
        POLICY=WAFPolicyCorridor.json
        NAME="corridor-waf"
        SCOPE_IS_FIXED="CLOUDFRONT"
        REGION_IS_FIXED="us-east-1"
        WEB_ACL_ID=$(aws wafv2 list-web-acls \
          --scope "${SCOPE_IS_FIXED}" \
          --region "${REGION_IS_FIXED}" \
          --query "WebACLs[?Name=='${NAME}'].Id | [0]" \
          --output text)
        aws wafv2 get-web-acl \
          --name "${NAME}" \
          --id "${WEB_ACL_ID}" \
          --scope "${SCOPE_IS_FIXED}" \
          --region "${REGION_IS_FIXED}" \
          > "current-${POLICY}"
        sed \
          -e 's/"SearchString": "POST"/"SearchString": "UE9TVA=="/g' \
          -e 's/"SearchString": "PUT"/"SearchString": "UFVU"/g' \
          -e 's/"SearchString": "DELETE"/"SearchString": "REVMRVRF"/g' \
          ".github/workflows/${POLICY}" \
        | jq -S '
            del(
              .Id,
              .ARN,
              .Capacity,
              .LabelNamespace,
              .ManagedByFirewallManager,
              .RetrofittedByFirewallManager
            )
          ' > "${POLICY}.sorted"
        jq -S '
          .WebACL
          | del(
              .Id,
              .ARN,
              .Capacity,
              .LabelNamespace,
              .ManagedByFirewallManager,
              .RetrofittedByFirewallManager
            )
        ' "current-${POLICY}" > "current-${POLICY}.sorted"
        diff "${POLICY}.sorted" "current-${POLICY}.sorted"
    - name: pre-check modified
      run: |
        set -euo pipefail
        git fetch --depth=2
        echo "CURR_SHA=${{ github.sha }}" >> $GITHUB_ENV
        echo "PREV_SHA=$(git rev-parse ${{ github.sha }}^)" >> $GITHUB_ENV
        echo "CURR_SHA=${{ github.sha }}"
        echo "PREV_SHA=$(git rev-parse ${{ github.sha }}^)"
    - name: check modified
      run: |
        set -euo pipefail
        MODIFIEDLIST=$(git diff --name-only $PREV_SHA $CURR_SHA | tr '\n' ' ')
        echo "MODIFIEDLIST=${MODIFIEDLIST}" >> $GITHUB_ENV
    - name: copy-files
      run: |
        set -euo pipefail
        FILES=(
          "${{ env.INDEXFILE }}"
          "${{ env.ADTXTFILE }}"
        )
        for FILE in "${FILES[@]}"; do
          SRC="${{ env.ROOTDIR }}/${FILE}"
          if [[ "${MODIFIEDLIST}" == *"${SRC}"* ]]; then
            DST="s3://${{ env.S3BUCKET }}/"
            aws s3 cp "${SRC}" "${DST}"
            aws s3 cp "${{ env.VERSION }}" "${DST}"
          fi
        done
    - name: sync-directories
      run: |
        set -euo pipefail
        DIRS=(
          "${{ env.IMAGEDIR }}"
          "${{ env.APPL1DIR }}"
          "${{ env.APPL2DIR }}"
          "${{ env.APPL3DIR }}"
          "${{ env.GA256DIR }}"
          "${{ env.GAFULDIR }}"
          "${{ env.APPL4DIR }}"
        )
        for DIR in "${DIRS[@]}"; do
          SRC="${{ env.ROOTDIR }}/${DIR}"
          if [[ "$MODIFIEDLIST" == *"$SRC"* ]]; then
            DST="s3://${{ env.S3BUCKET }}/${DIR}/"
            aws s3 sync "${SRC}" "${DST}" --exclude ".git/*" --exclude "lambda/**"
            aws s3 cp "${{ env.VERSION }}" "${DST}"
          fi
        done
    - name: deploy lambda (zip)
      if: contains(env.MODIFIEDLIST, env.APPL3DIR + '/lambda/')
      run: |
        set -euo pipefail
        LAMBDADIR="${{ env.ROOTDIR }}/${{ env.APPL3DIR }}/lambda"
        APP=llm.py
        ZIP="${APP}.zip"
        rm -f "${ZIP}"
        zip -q -j "${ZIP}" "${LAMBDADIR}/${APP}"
        aws lambda update-function-code \
          --function-name personalitytest \
          --zip-file "fileb://${ZIP}"
    - name: clear cache
      run: |
        aws cloudfront create-invalidation --distribution-id ${{ secrets.AWS_CLOUDFRONT_DISTRIBUTION }} --paths "/*"

