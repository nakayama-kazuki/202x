#!/bin/sh
set -e

API="http://${AWS_LAMBDA_RUNTIME_API}/2018-06-01/runtime"
CODEPATH="/var/task/handler.php"

while true
do
	UA_REQ_JSON=$(mktemp)
	RUNTIME_HEADERS=$(mktemp)
	UA_RES_ENTITY=$(mktemp)
	# get next event from Lambda Runtime API (blocks until an event arrives)
	curl -sS -D "$RUNTIME_HEADERS" "$API/invocation/next" > "$UA_REQ_JSON"
	REQ_ID=$(grep -i Lambda-Runtime-Aws-Request-Id "$RUNTIME_HEADERS" | awk '{print $2}' | tr -d '\r')
	php "$CODEPATH" < "$UA_REQ_JSON" > "$UA_RES_ENTITY"
	# send result back to Lambda Runtime API for this request-id
    curl -sS -X POST "$API/invocation/$REQ_ID/response" --data-binary @"$UA_RES_ENTITY"
    rm -f "$UA_REQ_JSON" "$RUNTIME_HEADERS" "$UA_RES_ENTITY"
done

