@python -c "exec(''.join(open(r'%~f0', encoding='utf-8').readlines()[1:]))" %* & goto:eof

import argparse
import os
import csv
import re
from collections import defaultdict, Counter

parser = argparse.ArgumentParser()
parser.add_argument("-listupNameCnt", type=int, default=0)
parser.add_argument("-listupDomain", type=str, default="")
args = parser.parse_args()

listup_name_cnt = args.listupNameCnt
listup_domain = args.listupDomain.lower()

input_files = [f for f in os.listdir(".") if f.endswith(".csv")]
output_file = "result.txt"
column_index_computer = 1
column_index_url = 11

domain_counts = Counter()
computer_counts = defaultdict(Counter)

for file in input_files:
    with open(file, encoding="cp932", errors="ignore") as f:
        reader = csv.reader(f)
        next(reader, None)  # skip header
        for row in reader:
            if len(row) <= column_index_url:
                continue
            url = row[column_index_url]
            match = re.match(r"^https?://([^/]+)", url)
            if not match:
                continue
            domain = match.group(1).lower()
            if listup_domain and not (domain.endswith("." + listup_domain) or domain == listup_domain):
                continue
            domain_counts[domain] += 1
            if listup_name_cnt > 0:
                computer_name = row[column_index_computer]
                computer_counts[domain][computer_name] += 1

with open(output_file, "w", encoding="utf-8") as f:
    for domain, count in domain_counts.most_common():
        f.write(f"{domain},{count}\n")
        if listup_name_cnt > 0 and domain in computer_counts:
            for comp, c_count in computer_counts[domain].most_common(listup_name_cnt):
                f.write(f"\t{comp},{c_count}\n")
